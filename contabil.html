<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cont√°bil ‚Äî Status e Progresso</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
body {
    margin:0;
    font-family:'Segoe UI',sans-serif;
    /* Estilo de fundo mais cyber/dark */
    background:radial-gradient(circle at top left,#0f2027,#203a43,#2c5364);
    color:#e0e0e0;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
}
h1 {
    margin-top:20px;
    /* Cor n√©on no t√≠tulo - Mantido como ciano/azul tecnol√≥gico */
    color:#00FFFF; 
    text-shadow:0 0 10px rgba(0,255,255,.5); 
    text-align:center;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
}
.chart-container {
    width:95%;
    height:70vh;
    margin-top:20px;
    background:rgba(255,255,255,.05);
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,.4);
    padding:20px;
    overflow-y:auto;
}
/* Estiliza√ß√£o para o novo container de filtros */
.controls-container {
    width: 95%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 10px 0;
}

/* NOVO: Alinhamento do label + select wrapper */
.controls-container > div {
    display: flex;
    align-items: center;
}

/* NOVO: Wrapper para a seta customizada */
.select-wrapper {
    position: relative;
    display: inline-block;
}

/* NOVO: Seta customizada */
.select-wrapper::after {
    content: '‚ñº';
    font-size: 12px;
    color: #00FFFF; /* Cor ciano */
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* Permite clicar no select por baixo */
}

/* Estiliza√ß√£o dos elementos de controle (DIVIDIDO) */
#statusFilter, .control-button {
    border-radius: 8px;
    border: 1px solid #00FFFF;
    background: rgba(0, 255, 255, 0.1);
    color: #e0e0e0;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s, box-shadow 0.3s;
}

.control-button {
    padding: 8px 12px;
}

#statusFilter {
    padding: 8px 35px 8px 12px; /* Padding direito para a seta */
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}

/* NOVO: Estiliza as op√ß√µes (o menu dropdown) */
#statusFilter option {
    background: #0f2027; /* Fundo dark (cor do body) */
    color: #e0e0e0;      /* Texto claro */
}

#statusFilter:hover, .control-button:hover {
    background: rgba(0, 255, 255, 0.3);
    box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
}

table {
    width:95%;
    border-collapse:collapse;
    margin:20px auto 40px auto; /* Ajuste para dar espa√ßo ao controle */
    background:rgba(255,255,255,.05);
    box-shadow:0 5px 20px rgba(0,0,0,.3);
    border-radius:12px;
    overflow:hidden;
}
th, td {
    padding:10px 14px;
    text-align:left;
    vertical-align:top;
}
th {
    /* Fundo azul/ciano tecnol√≥gico no cabe√ßalho */
    background:rgba(0, 255, 255, 0.3); /* Ciano com opacidade */
    color:#fff;
    text-transform:uppercase;
    letter-spacing:1px;
}
tr:nth-child(even){background:rgba(255,255,255,.03);}
tr.selected {
    /* Cor de destaque para linhas selecionadas na tabela */
    background: rgba(255, 255, 0, 0.2) !important; 
    box-shadow: 0 0 8px rgba(255, 255, 0, 0.5);
}
tr:hover{
    /* Destaque n√©on ao passar o mouse */
    background:rgba(0,255,255,.15);
    box-shadow: 0 0 5px rgba(0,255,255,.3); 
}
td{color:#d0e0ff;white-space:pre-line;}
a.voltar {
    display:inline-block;
    margin:20px;
    padding:10px 16px;
    border-radius:10px;
    /* Bot√£o azul/ciano tecnol√≥gico */
    background:rgba(0, 255, 255, 0.3); 
    color:#fff;
    text-decoration:none;
}
a.voltar:hover{
    background:rgba(0, 255, 255, 0.5);
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}
</style>
</head>
<body>
<h1>Cont√°bil ‚Äî Status e Progresso</h1>
<a href="index.html" class="voltar">‚Üê Voltar para Home</a>

<div class="chart-container">
    <canvas id="chartContabil"></canvas>
</div>

<div class="controls-container">
    <div>
        <label for="statusFilter" style="margin-right: 10px;">Filtrar por Status:</label>
        <div class="select-wrapper"> 
            <select id="statusFilter" onchange="handleStatusFilter(this.value)">
            </select>
        </div>
    </div>
    <button class="control-button" onclick="resetVisualization()">üîÑ Resetar Visualiza√ß√£o</button>
</div>
<table>
<thead><tr><th>ID</th><th>Empresa</th><th>Respons√°vel</th><th>Progresso</th><th>Observa√ß√µes</th><th>Status</th></tr></thead>
<tbody id="tableBody">
</tbody></table>

<script>
Chart.register(ChartDataLabels);

let allData = [];
let filteredStatus = null;
let chartLabels = [];
let chartOriginalData = [];
let chartColors = [];
let selectedEmpresas = []; 
let uniqueStatusList = [];

// Dados fixos conforme especificado (usado para o gr√°fico e como fallback de dados)
const fixedLabels = [
    'OK',
    'Pendencia Tadeu/Bianca/Helena',
    'Pendencia Tadeu/Fernando/Helena',
    'Conferida/Pendencia Cliente',
    'S/M',
    'Conferida/Pendencia Cliente/Bianca',
    '?',
    'Conferida/Pendencia Fernando/Fiscal',
    'Pendencia Marinelsi/Tadeu/Helena',
    'Pendencia Tadeu/Cassio/Helena'
];

const fixedData = [15, 7, 7, 5, 5, 2, 1, 1, 1, 1];

// Cores Corporativas/Tecnol√≥gicas (3 tons de Azul Ciano Escuro/Petr√≥leo)
const baseColors = [
    '#006064', 
    '#00838F', 
    '#00ACC1'  
];

// Inicializa dados e cores (Sempre executado)
function initializeChartData() {
    chartLabels = fixedLabels;
    chartOriginalData = fixedData;
    chartColors = chartOriginalData.map((_, index) => baseColors[index % baseColors.length]);
    uniqueStatusList = [...new Set(fixedLabels)]; 
}

// Popula o dropdown de filtro (Sempre executado)
function populateStatusFilter() {
    const select = document.getElementById('statusFilter');
    select.innerHTML = ''; // Limpa antes de popular

    // Adiciona a op√ß√£o padr√£o
    let defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Mostrar Todos';
    select.appendChild(defaultOption);

    // Adiciona as op√ß√µes de status
    uniqueStatusList.forEach(status => {
        let option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        select.appendChild(option);
    });
}


// Carrega dados do CSV (Adicionado tratamento de erro para fallback)
async function loadData() {
    initializeChartData(); // Garante que o gr√°fico e o filtro podem ser criados.
    populateStatusFilter();

    try {
        // Tenta carregar dados reais
        const response = await fetch('planilhas/OK - quem_somos__contabil.csv');
        if (!response.ok) throw new Error('Falha ao carregar CSV');

        const csv = await response.text();
        
        allData = [];
        let currentLine = '';
        let inQuotes = false;
        
        // L√≥gica de parsing do CSV
        for (let i = 0; i < csv.length; i++) {
            const char = csv[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
                currentLine += char;
            } else if (char === '\n' && !inQuotes) {
                if (currentLine.trim()) {
                    processLine(currentLine);
                }
                currentLine = '';
            } else {
                currentLine += char;
            }
        }
        
        if (currentLine.trim()) {
            processLine(currentLine);
        }
        
        // Remove o cabe√ßalho (espera-se que a primeira linha seja o cabe√ßalho)
        allData.shift(); 
        
    } catch (e) {
        console.warn('Erro ao carregar CSV (usando dados de exemplo):', e.message);
        
        // Se a leitura falhar (ex: erro de CORS local), cria dados mock para a tabela
        allData = fixedLabels.flatMap((status, index) => {
            const count = fixedData[index];
            return Array(count).fill(0).map((_, i) => ({
                empId: `${index + 1}-${i + 1}`,
                empresa: `Empresa Exemplo ${index + 1}-${i + 1}`,
                responsavel: 'Desconhecido',
                progresso: '100%',
                observacoes: 'Dados de Exemplo',
                status: status,
                uniqueId: `Exemplo-${index}-${i}`
            }));
        });
    }
    
    // Renderiza com os dados carregados ou mockados
    renderTable(allData);
    updateChart(chartOriginalData, chartColors);
}

function processLine(line) {
    const parts = [];
    let current = '';
    let inQuotes = false;
    
    for (let j = 0; j < line.length; j++) {
        const char = line[j];
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ';' && !inQuotes) {
            parts.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    parts.push(current);
    
    // Garante que a linha tem dados suficientes
    if (parts.length >= 6) {
        const empId = parts[0].trim();
        const empresa = parts[1].trim();
        const responsavel = parts[2].trim();
        const progresso = parts[3].trim();
        const observacoes = parts[4].replace(/"/g, '').trim();
        let status = parts[5].replace(/"/g, '').trim();
        
        // Corrige erro de digita√ß√£o no CSV: Fernandi -> Fernando
        status = status.replace('Fernandi', 'Fernando');
        
        if (empId && empresa) {
            allData.push({
                empId,
                empresa,
                responsavel,
                progresso,
                observacoes,
                status,
                uniqueId: `${empId}-${empresa}` 
            });
        }
    }
}

// Renderiza tabela
function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-unique-id', row.uniqueId);
        tr.style.cursor = 'pointer';
        
        const isSelected = selectedEmpresas.includes(row.uniqueId);
        if (isSelected) {
            tr.classList.add('selected');
        }

        tr.innerHTML = `
            <td><strong>${row.empId}</strong></td>
            <td>${row.empresa}</td>
            <td>${row.responsavel}</td>
            <td>${row.progresso}</td>
            <td>${row.observacoes}</td>
            <td>${row.status}</td>
        `;
        
        tr.addEventListener('click', () => {
            handleTableClick(tr, row.uniqueId, row.status);
        });
        
        tr.addEventListener('mouseenter', () => {
            if (!tr.classList.contains('selected')) {
                tr.style.background = 'rgba(0,255,255,.2)';
            }
        });
        tr.addEventListener('mouseleave', () => {
            if (!tr.classList.contains('selected')) {
                tr.style.background = '';
            }
        });

        tbody.appendChild(tr);
    });
}

// Gerencia a sele√ß√£o da linha da tabela e atualiza o gr√°fico
function handleTableClick(trElement, uniqueId, status) {
    // Garante que o filtro de status esteja resetado ao iniciar a sele√ß√£o por linha
    if (filteredStatus !== null) {
        handleStatusFilter('');
        document.getElementById('statusFilter').value = '';
    }

    const index = selectedEmpresas.indexOf(uniqueId);

    // Gerenciar sele√ß√£o do array
    if (index > -1) {
        selectedEmpresas.splice(index, 1);
        trElement.classList.remove('selected');
    } else {
        selectedEmpresas.push(uniqueId);
        trElement.classList.add('selected');
    }

    // Atualizar o gr√°fico e t√≠tulo
    const h1 = document.querySelector('h1');

    if (selectedEmpresas.length > 0) {
        updateChartFromSelection();
        h1.textContent = `Cont√°bil ‚Äî Empresas Selecionadas: ${selectedEmpresas.length}`;
    } else {
        updateChart(chartOriginalData, chartColors); 
        h1.textContent = 'Cont√°bil ‚Äî Status e Progresso';
    }
}

// Recalcula dados para acumula√ß√£o (clique na tabela)
function updateChartFromSelection() {
    const statusCounts = selectedEmpresas.map(id => {
        return allData.find(d => d.uniqueId === id).status;
    }).reduce((acc, status) => {
        acc[status] = (acc[status] || 0) + 1;
        return acc;
    }, {});
    
    const accumulatedData = chartLabels.map(label => statusCounts[label] || 0);
    
    updateChart(accumulatedData, chartColors, true);
}


// Atualiza gr√°fico (Fun√ß√£o centralizada para plotar)
function updateChart(dataToPlot, colorsToPlot, isAccumulated = false, isStatusFiltered = false) {
    if (window.chartInstance) {
        window.chartInstance.destroy();
    }
    
    const ctx = document.getElementById('chartContabil').getContext('2d');
    const maxData = Math.max(...dataToPlot, 1);
    
    window.chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: isAccumulated ? 'Empresas Selecionadas' : 'Qtd. de Empresas',
                data: dataToPlot,
                backgroundColor: colorsToPlot,
                borderColor: '#e0e0e0', 
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            // A√ß√£o ao clicar na barra do gr√°fico (s√≥ funciona se n√£o estiver em modo acumulado ou filtrado)
            onClick: (event, elements) => {
                if (elements.length > 0 && !isAccumulated && !isStatusFiltered) {
                    const index = elements[0].index;
                    const status = chartLabels[index];
                    
                    handleStatusFilter(status);
                    document.getElementById('statusFilter').value = status;
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    // Ajusta o max X para o modo acumulado/filtrado
                    max: isAccumulated || isStatusFiltered ? maxData * 1.1 : undefined, 
                    grid: { color: 'rgba(255,255,255,.1)' },
                    ticks: { color: '#e0e0e0' },
                    title: { display: true, text: 'Quantidade de Empresas', color: '#00FFFF' }
                },
                y: { grid: { color: 'rgba(255,255,255,.05)' }, ticks: { color: '#e0e0e0' } }
            },
            plugins: {
                legend: { labels: { color: '#e0e0e0' } },
                tooltip: { 
                    callbacks: { 
                        label: ctx => {
                            if ((isAccumulated || isStatusFiltered) && ctx.parsed.x === 0) return null;
                            return ctx.parsed.x + ' empresas'; 
                        } 
                    } 
                },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: '#ffffff',
                    font: { 
                        weight: 'bold', 
                        size: 14
                    },
                    formatter: (value) => value > 0 ? value : '', 
                    backgroundColor: function(context) {
                        return context.dataset.backgroundColor[context.dataIndex] + 'CC'; 
                    },
                    borderWidth: 2,
                    borderRadius: 6,
                    padding: 8,
                    offset: 10
                }
            }
        }
    });
}

// Fun√ß√£o para lidar com o filtro do Dropdown
function handleStatusFilter(status) {
    // Limpa a sele√ß√£o de linhas ao usar o filtro do dropdown
    selectedEmpresas = []; 
    document.querySelectorAll('tr.selected').forEach(tr => tr.classList.remove('selected'));

    if (status === '' || status === null) {
        // Mostrar Todos
        filteredStatus = null;
        renderTable(allData);
        updateChart(chartOriginalData, chartColors);
        document.querySelector('h1').textContent = 'Cont√°bil ‚Äî Status e Progresso';

    } else {
        // Filtro por status
        filteredStatus = status;
        const filtered = allData.filter(d => d.status === filteredStatus);
        renderTable(filtered);
        
        // Recalcula dados para o gr√°fico baseado no filtro (mantendo 0 para os outros status)
        const statusData = chartLabels.map(label => label === filteredStatus ? 
            fixedData[chartLabels.indexOf(filteredStatus)] : 0);

        updateChart(statusData, chartColors, false, true);
        document.querySelector('h1').textContent = `Cont√°bil ‚Äî Status: ${filteredStatus}`;
    }
}

// Fun√ß√£o para resetar toda a visualiza√ß√£o
function resetVisualization() {
    // Reseta o filtro de status
    filteredStatus = null;
    document.getElementById('statusFilter').value = '';

    // Reseta a sele√ß√£o de linhas
    selectedEmpresas = [];
    document.querySelectorAll('tr.selected').forEach(tr => tr.classList.remove('selected'));

    // Reseta a tabela para todos os dados
    renderTable(allData);

    // Reseta o gr√°fico para a vis√£o completa
    updateChart(chartOriginalData, chartColors);

    // Reseta o t√≠tulo
    document.querySelector('h1').textContent = 'Cont√°bil ‚Äî Status e Progresso';
}

// Carrega dados ao iniciar
loadData();
</script>
</body>
</html>